
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>executorch.devtools.etrecord._etrecord &#8212; ExecuTorch main documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=047068a3" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../../_static/documentation_options.js?v=a8da1a53"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/executorch/devtools/etrecord/_etrecord';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.pytorch.org/executorch/executorch-versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = true;
        </script>
    <link rel="canonical" href="https://docs.pytorch.org/executorch/_modules/executorch/devtools/etrecord/_etrecord.html" />
    <link rel="icon" href="../../../../_static/executorch-chip-logo.svg"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
<script>
  if (window.location.hostname === 'docs.pytorch.org' || window.location.hostname === 'docs-preview.pytorch.org') {
    const script = document.createElement('script');
    script.src = 'https://cmp.osano.com/16A0DbT9yDNIaQkvZ/31b1b91a-e0b6-47ea-bde2-7f2bd13dbe5c/osano.js?variant=one';
    document.head.appendChild(script);
  }
</script>
<script>
  // Cookie banner for non-LF projects
  document.addEventListener('DOMContentLoaded', function () {
    // Hide cookie banner on local environments and LF owned docs
    if (window.location.hostname === 'localhost' ||
      window.location.hostname === '0.0.0.0' ||
      window.location.hostname === '127.0.0.1' ||
      window.location.hostname === 'docs.pytorch.org' ||
      window.location.hostname === 'docs-preview.pytorch.org' ||
      window.location.hostname.startsWith('192.168.')) {
      const banner = document.querySelector('.cookie-banner-wrapper');
      if (banner) {
        banner.style.display = 'none';
      }
    }
  });
</script>
<!-- Conditional CSS for header and footer height adjustment -->


<link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css" crossorigin="anonymous">
<script type="text/javascript" src="../../../../_static/js/theme.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400&display=swap" rel="stylesheet">
<meta property="og:image" content="https://docs.pytorch.org/docs/stable/_static/img/pytorch_seo.png" />
<link rel="stylesheet" href="../../../../_static/webfonts/all.min.css" crossorigin="anonymous">
<meta http-equiv="Content-Security-Policy"
  content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval' blob:;">
<meta name="pytorch_project" content="">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS" height="0" width="0"
    style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<!-- Google Tag Manager -->
<script>(function (w, d, s, l, i) {
    w[l] = w[l] || []; w[l].push({
      'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    }); var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    j.onload = function () {
      window.dispatchEvent(new Event('gtm_loaded'));
      console.log('GTM loaded successfully');
    };
  })(window, document, 'script', 'dataLayer', 'GTM-T8XT4PS');
</script>
<!-- End Google Tag Manager -->
<!-- Facebook Pixel Code -->
<script>
  !function (f, b, e, v, n, t, s) {
    if (f.fbq) return; n = f.fbq = function () {
      n.callMethod ?
        n.callMethod.apply(n, arguments) : n.queue.push(arguments)
    };
    if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
    n.queue = []; t = b.createElement(e); t.async = !0;
    t.src = v; s = b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t, s)
  }(window, document, 'script',
    'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '243028289693773');
  fbq('track', 'PageView');
</script>
<script>
  document.documentElement.setAttribute('data-version', 'main');
</script>
<noscript>
  <img height="1" width="1" src="https://www.facebook.com/tr?id=243028289693773&ev=PageView&noscript=1" />
</noscript>
<script>
  function gtag() {
    window.dataLayer.push(arguments);
  }
</script>
<!-- End Facebook Pixel Code -->
<!-- Repository configuration for tutorials -->

<!-- Script to Fix scrolling -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Fix anchor scrolling
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          const headerHeight =
            (document.querySelector('.header-holder') ? document.querySelector('.header-holder').offsetHeight : 0) +
            (document.querySelector('.bd-header') ? document.querySelector('.bd-header').offsetHeight : 0) + 20;

          const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });

          // Update URL hash without scrolling
          history.pushState(null, null, '#' + targetId);
        }
      });
    });
  });
</script>

<script async src="https://cse.google.com/cse.js?cx=e65585f8c3ea1440e"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>

  </head>

<body data-feedback-url="https://github.com/pytorch/executorch" class="pytorch-body">
  
    <div class="container-fluid header-holder tutorials-header" id="header-holder">
   <div class="header-container-wrapper">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                <span>Learn</span>
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/get-started/locally">
                  <span class=dropdown-title>Get Started</span>
                </a>
                <a class="nav-dropdown-item" href="https://docs.pytorch.org/tutorials">
                  <span class="dropdown-title">Tutorials</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">Learn the Basics</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch Recipes</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">Intro to PyTorch - YouTube Series</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/webinars/">
                  <span class="dropdown-title">Webinars</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
              <span>Community</span>
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://landscape.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Landscape</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/join-ecosystem">
                  <span class="dropdown-title">Join the Ecosystem</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-hub/">
                  <span class="dropdown-title">Community Hub</span>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/">
                  <span class="dropdown-title">Forums</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class=dropdown-title>Developer Resources</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/contributor-awards/">
                  <span class="dropdown-title">Contributor Awards</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-events/">
                  <span class="dropdown-title">Community Events</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/programs/ambassadors/">
                  <span class="dropdown-title">PyTorch Ambassadors</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
              <span>Projects</span>
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/projects/pytorch/">
                  <span class="dropdown-title">PyTorch</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/projects/vllm/">
                  <span class="dropdown-title">vLLM</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/projects/deepspeed/">
                  <span class="dropdown-title">DeepSpeed</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/projects/host-your-project/">
                  <span class="dropdown-title">Host Your Project</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/projects/ray/">
                  <span class="dropdown-title">RAY</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
              <span> Docs</span>
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://docs.pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/domains">
                  <span class="dropdown-title">Domains</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
              <span>Blogs & News</span>
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
                  <span class="dropdown-title">Blog</span>
                </a>
                 <a class="nav-dropdown-item" href="https://pytorch.org/announcements">
                  <span class="dropdown-title">Announcements</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/case-studies/">
                  <span class="dropdown-title">Case Studies</span>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/newsletter">
                  <span class="dropdown-title">Newsletter</span>
                </a>
            </div>
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
              <span>About</span>
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/members">
                  <span class="dropdown-title">Members</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
                  <span class="dropdown-title">Governing Board</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tac">
                  <span class="dropdown-title">Technical Advisory Council</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/credits">
                  <span class="dropdown-title">Cloud Credit Program</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/staff">
                  <span class="dropdown-title">Staff</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/contact">
                  <span class="dropdown-title">Contact</span>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/wp-content/uploads/2025/09/pytorch_brand_guide_091925a.pdf">
                  <span class="dropdown-title">Brand Guidelines</span>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown main-menu-button">
              <a href="https://pytorch.org/join" data-cta="join">
                JOIN
              </a>
            </div>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu">
        <i class="fa-solid fa-ellipsis"></i>
      </a>
    </div>
  </div>
 </div>

 <!-- Begin Mobile Menu -->

<div class="mobile-main-menu">
  <div class="container-fluid">
    <div class="header-container-wrapper">
      <div class="mobile-main-menu-header-container">
        <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu">
        </a>
      </div>
    </div>
  </div>

  <div class="mobile-main-menu-links-container">
    <div class="main-menu">
      <ul>
         <li class="resources-mobile-menu-title">
           <a>Learn</a>
         </li>
         <ul class="resources-mobile-menu-items">
           <li>
             <a href="https://pytorch.org/get-started/locally">Get Started</a>
           </li>
           <li>
             <a href="https://docs.pytorch.org/tutorials">Tutorials</a>
           </li>
           <li>
             <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">Learn the Basics</a>
           </li>
           <li>
             <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">PyTorch Recipes</a>
           </li>
           <li>
             <a href="https://pytorch.org/tutorials/beginner/introyt.html">Introduction to PyTorch - YouTube Series</a>
           </li>
           <li>
            <a href="https://pytorch.org/webinars/">Webinars</a>
          </li>
        </ul>
         <li class="resources-mobile-menu-title">
           <a>Community</a>
         </li>
         <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://landscape.pytorch.org/">Landscape</a>
          </li>
          <li>
             <a href="https://pytorch.org/join-ecosystem">Join the Ecosystem</a>
           </li>
           <li>
             <a href="https://pytorch.org/community-hub/">Community Hub</a>
           </li>
           <li>
             <a href="https://discuss.pytorch.org/">Forums</a>
           </li>
           <li>
             <a href="https://pytorch.org/resources">Developer Resources</a>
           </li>
           <li>
             <a href="https://pytorch.org/contributor-awards/">Contributor Awards</a>
           </li>
           <li>
            <a href="https://pytorch.org/community-events/">Community Events</a>
          </li>
          <li>
            <a href="https://pytorch.org/programs/ambassadors/">PyTorch Ambassadors</a>
          </li>
       </ul>

         <li class="resources-mobile-menu-title">
           <a>Projects</a>
         </li>

         <ul class="resources-mobile-menu-items">
           <li>
             <a href="https://pytorch.org/projects/pytorch/">PyTorch</a>
           </li>

           <li>
             <a href="https://pytorch.org/projects/vllm/">vLLM</a>
           </li>
           <li>
            <a href="https://pytorch.org/projects/deepspeed/">DeepSpeed</a>
          </li>
          <li>
             <a href="https://pytorch.org/projects/host-your-project/">Host Your Project</a>
           </li>
         </ul>

         <li class="resources-mobile-menu-title">
           <a>Docs</a>
         </li>

         <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://docs.pytorch.org/docs/stable/index.html">PyTorch</a>
          </li>

          <li>
            <a href="https://pytorch.org/domains">Domains</a>
          </li>
        </ul>

        <li class="resources-mobile-menu-title">
          <a>Blog & News</a>
        </li>

         <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>
          <li>
            <a href="https://pytorch.org/announcements">Announcements</a>
          </li>

          <li>
            <a href="https://pytorch.org/case-studies/">Case Studies</a>
          </li>
          <li>
            <a href="https://pytorch.org/events">Events</a>
          </li>
          <li>
             <a href="https://pytorch.org/newsletter">Newsletter</a>
           </li>
        </ul>

        <li class="resources-mobile-menu-title">
          <a>About</a>
        </li>

        <ul class="resources-mobile-menu-items">
          <li>
            <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
          </li>
          <li>
            <a href="https://pytorch.org/members">Members</a>
          </li>
          <li>
            <a href="https://pytorch.org/governing-board">Governing Board</a>
          </li>
          <li>
            <a href="https://pytorch.org/tac">Technical Advisory Council</a>
         </li>
         <li>
             <a href="https://pytorch.org/credits">Cloud Credit Program</a>
          </li>
          <li>
             <a href="https://pytorch.org/staff">Staff</a>
          </li>
          <li>
             <a href="https://pytorch.org/contact">Contact</a>
          </li>
        </ul>
      </ul>
    </div>
  </div>
</div>

<!-- End Mobile Menu -->
  
  
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/et-logo.png" class="logo__image only-light" alt="ExecuTorch main documentation - Home"/>
    <script>document.write(`<img src="../../../../_static/et-logo.png" class="logo__image only-dark" alt="ExecuTorch main documentation - Home"/>`);</script>
  
  
</a></div>
    
      <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../intro-section.html">
    Intro
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../quick-start-section.html">
    Quick Start
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../edge-platforms-section.html">
    Edge
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../backends-section.html">
    Backends
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../llm/working-with-llms.html">
    LLMs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../advanced-topics-section.html">
    Advanced
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../tools-section.html">
    Tools
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api-section.html">
    API
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../../../support-section.html">
    Support
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">
  
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/executorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.pytorch.org/" title="Discourse" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/executorch" title="PyPi" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPi</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../intro-section.html">
    Intro
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../quick-start-section.html">
    Quick Start
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../edge-platforms-section.html">
    Edge
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../backends-section.html">
    Backends
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../llm/working-with-llms.html">
    LLMs
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../advanced-topics-section.html">
    Advanced
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../tools-section.html">
    Tools
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api-section.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../support-section.html">
    Support
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
  
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://x.com/PyTorch" title="X" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-x-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">X</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/pytorch/executorch" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.pytorch.org/" title="Discourse" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discourse</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/executorch" title="PyPi" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPi</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">executorch.d...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-behavior="tutorial-rating" data-count="1" data-value="1">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="2" data-value="2">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="3" data-value="3">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="4" data-value="4">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="5" data-value="5">★</span>
        
    </div>
</div>
</div>
      
    </div>
  
</div>
</div>
              
              
  
<div id="searchbox"></div>
  <article class="bd-article" id="pytorch-article">
    <!-- Hidden breadcrumb schema for SEO only -->
    <div style="display:none;" itemscope itemtype="https://schema.org/BreadcrumbList">
      
      <div itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <link itemprop="item" href="../../../index.html">
        <meta itemprop="name" content="Module code">
        <meta itemprop="position" content="1">
      </div>
      
      <div itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <meta itemprop="name" content="executorch.devtools.etrecord._etrecord">
        <meta itemprop="position" content="2">
      </div>
    </div>

    
    

    
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for executorch.devtools.etrecord._etrecord</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the BSD-style license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="c1"># pyre-unsafe</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">IO</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">BadZipFile</span><span class="p">,</span> <span class="n">ZipFile</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">executorch</span><span class="w"> </span><span class="kn">import</span> <span class="n">exir</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">executorch.devtools.bundled_program.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConfigValue</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">executorch.devtools.bundled_program.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">BundledProgram</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">executorch.exir</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">EdgeProgramManager</span><span class="p">,</span>
    <span class="n">ExecutorchProgram</span><span class="p">,</span>
    <span class="n">ExecutorchProgramManager</span><span class="p">,</span>
    <span class="n">ExirExportedProgram</span><span class="p">,</span>
    <span class="n">ExportedProgram</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">executorch.exir.emit._emitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">_DelegateDebugIdentifierMap</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">executorch.exir.serde.export_serialize</span><span class="w"> </span><span class="kn">import</span> <span class="n">SerializedArtifact</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">executorch.exir.serde.serialize</span><span class="w"> </span><span class="kn">import</span> <span class="n">deserialize</span><span class="p">,</span> <span class="n">serialize</span>

<span class="n">ProgramInput</span> <span class="o">=</span> <span class="n">ConfigValue</span>
<span class="n">ProgramOutput</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># breaking change introduced in python 3.11</span>
    <span class="c1"># pyre-ignore</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">StrEnum</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">StrEnum</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ETRecordReservedFileNames</span><span class="p">(</span><span class="n">StrEnum</span><span class="p">):</span>
    <span class="n">ETRECORD_IDENTIFIER</span> <span class="o">=</span> <span class="s2">&quot;ETRECORD_V0&quot;</span>
    <span class="n">EXPORTED_PROGRAM</span> <span class="o">=</span> <span class="s2">&quot;exported_program&quot;</span>
    <span class="n">EXPORT_GRAPH_ID</span> <span class="o">=</span> <span class="s2">&quot;export_graph_id&quot;</span>
    <span class="n">EDGE_DIALECT_EXPORTED_PROGRAM</span> <span class="o">=</span> <span class="s2">&quot;edge_dialect_exported_program&quot;</span>
    <span class="n">ET_DIALECT_GRAPH_MODULE</span> <span class="o">=</span> <span class="s2">&quot;et_dialect_graph_module&quot;</span>
    <span class="n">DEBUG_HANDLE_MAP_NAME</span> <span class="o">=</span> <span class="s2">&quot;debug_handle_map&quot;</span>
    <span class="n">DELEGATE_MAP_NAME</span> <span class="o">=</span> <span class="s2">&quot;delegate_map&quot;</span>
    <span class="n">INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME</span> <span class="o">=</span> <span class="s2">&quot;instruction_id_to_num_outs_map&quot;</span>
    <span class="n">REFERENCE_OUTPUTS</span> <span class="o">=</span> <span class="s2">&quot;reference_outputs&quot;</span>
    <span class="n">REPRESENTATIVE_INPUTS</span> <span class="o">=</span> <span class="s2">&quot;representative_inputs&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ETRecord</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exported_program</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">export_graph_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge_dialect_program</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">graph_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_debug_handle_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_delegate_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_DelegateDebugIdentifierMap</span><span class="p">]]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_instruction_id_to_num_outs_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_reference_outputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ProgramOutput</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_representative_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ProgramInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Please do not construct an ETRecord object directly.</span>

<span class="sd">        If you want to create an ETRecord for logging AOT information to further analysis, please mark `generate_etrecord`</span>
<span class="sd">        as True in your export api, and get the ETRecord object from the `ExecutorchProgramManager`.</span>
<span class="sd">        For exmaple:</span>
<span class="sd">        ```python</span>
<span class="sd">            exported_program = torch.export.export(model, inputs)</span>
<span class="sd">            edge_program = to_edge_transform_and_lower(exported_program, generate_etrecord=True)</span>
<span class="sd">            executorch_program = edge_program.to_executorch()</span>
<span class="sd">            etrecord = executorch_program.get_etrecord()</span>
<span class="sd">        ```</span>

<span class="sd">        If user need to create an ETRecord manually, please use the `create_etrecord` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exported_program</span> <span class="o">=</span> <span class="n">exported_program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_graph_id</span> <span class="o">=</span> <span class="n">export_graph_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_dialect_program</span> <span class="o">=</span> <span class="n">edge_dialect_program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_map</span> <span class="o">=</span> <span class="n">graph_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_handle_map</span> <span class="o">=</span> <span class="n">_debug_handle_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_map</span> <span class="o">=</span> <span class="n">_delegate_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instruction_id_to_num_outs_map</span> <span class="o">=</span> <span class="n">_instruction_id_to_num_outs_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="o">=</span> <span class="n">_reference_outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span> <span class="o">=</span> <span class="n">_representative_inputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">IO</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize and save the ETRecord to the specified path for use in Inspector. The ETRecord</span>
<span class="sd">        should contains at least edge dialect program and executorch program information for further</span>
<span class="sd">        analysis, otherwise it will raise an exception.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: Path where the ETRecord file will be saved to.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If the ETRecord does not contain essential information for Inpector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)):</span>
            <span class="c1"># pyre-ignore[6]: In call `os.fspath`, for 1st positional argument, expected `str` but got `Union[PathLike[typing.Any], str]`</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edge_dialect_program</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug_handle_map</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;ETRecord must contain edge dialect program and executorch program to be saved&quot;</span>
            <span class="p">)</span>

        <span class="n">etrecord_zip</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_identifier</span><span class="p">(</span><span class="n">etrecord_zip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_programs</span><span class="p">(</span><span class="n">etrecord_zip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_graph_map</span><span class="p">(</span><span class="n">etrecord_zip</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_metadata</span><span class="p">(</span><span class="n">etrecord_zip</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etrecord_zip</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write the magic file identifier.&quot;&quot;&quot;</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">ETRECORD_IDENTIFIER</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_programs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etrecord_zip</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save exported program and edge dialect program.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exported_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_exported_program</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="p">,</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EXPORTED_PROGRAM</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exported_program</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_dialect_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_edge_dialect_program</span><span class="p">(</span><span class="n">etrecord_zip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_dialect_program</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_graph_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etrecord_zip</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save graph map if present.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># pyre-ignore[16]: Undefined attribute [16]: `Optional` has no attribute `items`.</span>
            <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">export_module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">module_name</span><span class="p">:</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">method_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_exported_program</span><span class="p">(</span>
                        <span class="n">etrecord_zip</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="n">export_module</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_exported_program</span><span class="p">(</span>
                        <span class="n">etrecord_zip</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="s2">&quot;forward&quot;</span><span class="p">,</span> <span class="n">export_module</span>
                    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etrecord_zip</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save debug maps, reference outputs, and other metadata.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug_handle_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">DEBUG_HANDLE_MAP_NAME</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug_handle_map</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">DELEGATE_MAP_NAME</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_delegate_map</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruction_id_to_num_outs_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_instruction_id_to_num_outs_map</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">REFERENCE_OUTPUTS</span><span class="p">,</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">REPRESENTATIVE_INPUTS</span><span class="p">,</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_graph_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
                <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EXPORT_GRAPH_ID</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">export_graph_id</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_exported_program</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">etrecord_zip</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span>
        <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ep</span><span class="p">:</span> <span class="n">ExportedProgram</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save an exported program to the ETRecord zip file.&quot;&quot;&quot;</span>
        <span class="n">serialized_artifact</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">ep</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serialized_artifact</span><span class="o">.</span><span class="n">exported_program</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>

        <span class="n">method_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">method_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">exported_program</span><span class="p">)</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_state_dict&quot;</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_constants&quot;</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">constants</span><span class="p">)</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_example_inputs&quot;</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">example_inputs</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_edge_dialect_program</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">etrecord_zip</span><span class="p">:</span> <span class="n">ZipFile</span><span class="p">,</span> <span class="n">edge_dialect_program</span><span class="p">:</span> <span class="n">ExportedProgram</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the edge dialect program to the ETRecord zip file.&quot;&quot;&quot;</span>
        <span class="n">serialized_artifact</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span><span class="n">edge_dialect_program</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serialized_artifact</span><span class="o">.</span><span class="n">exported_program</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>

        <span class="n">base_name</span> <span class="o">=</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EDGE_DIALECT_EXPORTED_PROGRAM</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">exported_program</span><span class="p">)</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_state_dict&quot;</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">state_dict</span><span class="p">)</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_constants&quot;</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">constants</span><span class="p">)</span>
        <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_example_inputs&quot;</span><span class="p">,</span> <span class="n">serialized_artifact</span><span class="o">.</span><span class="n">example_inputs</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_extra_export_modules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">extra_recorded_export_modules</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">ExportedProgram</span><span class="p">,</span>
                <span class="n">ExirExportedProgram</span><span class="p">,</span>
                <span class="n">EdgeProgramManager</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add extra export modules to the ETRecord after it has been created.</span>

<span class="sd">        This method allows users to add more export modules they want to record</span>
<span class="sd">        to an existing ETRecord instance. The modules will be added to the graph_map</span>
<span class="sd">        and will be included when the ETRecord is saved.</span>

<span class="sd">        Args:</span>
<span class="sd">            extra_recorded_export_modules: A dictionary of graph modules with the key being</span>
<span class="sd">                the user provided name and the value being the corresponding exported module.</span>
<span class="sd">                The exported graph modules can be either the output of `torch.export()` or `exir.to_edge()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Now self.graph_map is guaranteed to be non-None</span>
        <span class="n">graph_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_map</span>
        <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">export_module</span> <span class="ow">in</span> <span class="n">extra_recorded_export_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_add_module_to_graph_map</span><span class="p">(</span><span class="n">graph_map</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">export_module</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_executorch_program</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">executorch_program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">ExecutorchProgram</span><span class="p">,</span>
            <span class="n">ExecutorchProgramManager</span><span class="p">,</span>
            <span class="n">BundledProgram</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add executorch program data to the ETRecord after it has been created.</span>

<span class="sd">        This method allows users to add executorch program data they want to record</span>
<span class="sd">        to an existing ETRecord instance. The executorch program data includes debug handle map,</span>
<span class="sd">        delegate map, reference outputs, and representative inputs that will be included</span>
<span class="sd">        when the ETRecord is saved.</span>

<span class="sd">        Args:</span>
<span class="sd">            executorch_program: The ExecuTorch program for this model returned by the call to</span>
<span class="sd">                `to_executorch()` or the `BundledProgram` of this model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If executorch program data already exists in the ETRecord.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if executorch program data already exists</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_handle_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instruction_id_to_num_outs_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Executorch program data already exists in the ETRecord. &quot;</span>
                <span class="s2">&quot;Cannot add executorch program data when it already exists.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process executorch program and extract data</span>
        <span class="p">(</span>
            <span class="n">debug_handle_map</span><span class="p">,</span>
            <span class="n">delegate_map</span><span class="p">,</span>
            <span class="n">instruction_id_to_num_outs_map</span><span class="p">,</span>
            <span class="n">reference_outputs</span><span class="p">,</span>
            <span class="n">representative_inputs</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_process_executorch_program</span><span class="p">(</span><span class="n">executorch_program</span><span class="p">)</span>

        <span class="c1"># Set the extracted data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_handle_map</span> <span class="o">=</span> <span class="n">debug_handle_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delegate_map</span> <span class="o">=</span> <span class="n">delegate_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instruction_id_to_num_outs_map</span> <span class="o">=</span> <span class="n">instruction_id_to_num_outs_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="o">=</span> <span class="n">reference_outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span> <span class="o">=</span> <span class="n">representative_inputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_exported_program</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exported_program</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add exported program to the ETRecord after it has been created.</span>

<span class="sd">        This method allows users to add an exported program they want to record</span>
<span class="sd">        to an existing ETRecord instance. The exported program will be included</span>
<span class="sd">        when the ETRecord is saved.</span>

<span class="sd">        Args:</span>
<span class="sd">            exported_program: The exported program for this model returned by the call to</span>
<span class="sd">                `torch.export()` or a dictionary with method names as keys and exported programs as values.</span>
<span class="sd">                Can be None, in which case no exported program data will be added.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If exported program already exists in the ETRecord.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if exported program already exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exported_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_graph_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Exported program already exists in the ETRecord. &quot;</span>
                <span class="s2">&quot;Cannot add exported program when it already exists.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process exported program and extract data</span>
        <span class="n">processed_exported_program</span><span class="p">,</span> <span class="n">export_graph_id</span> <span class="o">=</span> <span class="n">_process_exported_program</span><span class="p">(</span>
            <span class="n">exported_program</span>
        <span class="p">)</span>

        <span class="c1"># Set the extracted data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exported_program</span> <span class="o">=</span> <span class="n">processed_exported_program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_graph_id</span> <span class="o">=</span> <span class="n">export_graph_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_edge_dialect_program</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">edge_dialect_program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EdgeProgramManager</span><span class="p">,</span> <span class="n">ExirExportedProgram</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add edge dialect program to the ETRecord after it has been created.</span>

<span class="sd">        This method allows users to add an edge dialect program they want to record</span>
<span class="sd">        to an existing ETRecord instance. The edge dialect program will be included</span>
<span class="sd">        when the ETRecord is saved.</span>

<span class="sd">        Args:</span>
<span class="sd">            edge_dialect_program: The edge dialect program for this model returned by the call to</span>
<span class="sd">                `to_edge()` or `EdgeProgramManager` for this model.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If edge dialect program already exists in the ETRecord.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if edge dialect program already exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_dialect_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Edge dialect program already exists in the ETRecord. &quot;</span>
                <span class="s2">&quot;Cannot add edge dialect program when it already exists.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Process edge dialect program and extract data</span>
        <span class="n">processed_edge_dialect_program</span> <span class="o">=</span> <span class="n">_process_edge_dialect_program</span><span class="p">(</span>
            <span class="n">edge_dialect_program</span>
        <span class="p">)</span>

        <span class="c1"># Set the extracted data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_dialect_program</span> <span class="o">=</span> <span class="n">processed_edge_dialect_program</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_representative_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">representative_inputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ProgramInput</span><span class="p">],</span> <span class="n">BundledProgram</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the representative inputs in the ETRecord.</span>

<span class="sd">        This method allows users to customize the representative inputs that will be</span>
<span class="sd">        included when the ETRecord is saved. The representative inputs can be provided</span>
<span class="sd">        directly as a list or extracted from a BundledProgram.</span>

<span class="sd">        Args:</span>
<span class="sd">            representative_inputs: Either a list of ProgramInput objects or a BundledProgram</span>
<span class="sd">                from which representative inputs will be extracted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">representative_inputs</span><span class="p">,</span> <span class="n">BundledProgram</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span> <span class="o">=</span> <span class="n">_get_representative_inputs</span><span class="p">(</span>
                <span class="n">representative_inputs</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_representative_inputs</span> <span class="o">=</span> <span class="n">representative_inputs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_reference_outputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reference_outputs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
            <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ProgramOutput</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">ProgramOutput</span><span class="p">],</span> <span class="n">BundledProgram</span>
        <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the reference outputs in the ETRecord.</span>

<span class="sd">        This method allows users to customize the reference outputs that will be</span>
<span class="sd">        included when the ETRecord is saved. The reference outputs can be provided</span>
<span class="sd">        directly as a dictionary mapping method names to lists of outputs, as a</span>
<span class="sd">        single list of outputs (which will be treated as {&quot;forward&quot;: List[ProgramOutput]}),</span>
<span class="sd">        or extracted from a BundledProgram.</span>

<span class="sd">        Args:</span>
<span class="sd">            reference_outputs: Either a dictionary mapping method names to lists of</span>
<span class="sd">                ProgramOutput objects, a single list of ProgramOutput objects (treated</span>
<span class="sd">                as outputs for the &quot;forward&quot; method), or a BundledProgram from which</span>
<span class="sd">                reference outputs will be extracted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference_outputs</span><span class="p">,</span> <span class="n">BundledProgram</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="o">=</span> <span class="n">_get_reference_outputs</span><span class="p">(</span><span class="n">reference_outputs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference_outputs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;forward&quot;</span><span class="p">:</span> <span class="n">reference_outputs</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_outputs</span> <span class="o">=</span> <span class="n">reference_outputs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_reference_outputs</span><span class="p">(</span>
    <span class="n">bundled_program</span><span class="p">:</span> <span class="n">BundledProgram</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ProgramOutput</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts out the expected outputs from the bundled program, keyed by the method names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference_outputs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">method_test_suite</span> <span class="ow">in</span> <span class="n">bundled_program</span><span class="o">.</span><span class="n">method_test_suites</span><span class="p">:</span>
        <span class="n">reference_outputs</span><span class="p">[</span><span class="n">method_test_suite</span><span class="o">.</span><span class="n">method_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">test_case</span> <span class="ow">in</span> <span class="n">method_test_suite</span><span class="o">.</span><span class="n">test_cases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">test_case</span><span class="o">.</span><span class="n">expected_outputs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing at least one set of expected outputs for method </span><span class="si">{</span><span class="n">method_test_suite</span><span class="o">.</span><span class="n">method_name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="n">reference_outputs</span><span class="p">[</span><span class="n">method_test_suite</span><span class="o">.</span><span class="n">method_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">test_case</span><span class="o">.</span><span class="n">expected_outputs</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">reference_outputs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_representative_inputs</span><span class="p">(</span>
    <span class="n">bundled_program</span><span class="p">:</span> <span class="n">BundledProgram</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ProgramInput</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts out the inputs from the bundled program, keyed by the method names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">method_test_suite</span> <span class="ow">in</span> <span class="n">bundled_program</span><span class="o">.</span><span class="n">method_test_suites</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method_test_suite</span><span class="o">.</span><span class="n">method_name</span> <span class="o">==</span> <span class="s2">&quot;forward&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">method_test_suite</span><span class="o">.</span><span class="n">test_cases</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;forward&#39; method is defined, but no corresponding input test cases are provided.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Get first example input from the forward method</span>
            <span class="n">test_case</span> <span class="o">=</span> <span class="n">method_test_suite</span><span class="o">.</span><span class="n">test_cases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">test_case</span><span class="o">.</span><span class="n">inputs</span>

    <span class="c1"># If the forward method is not defined, return None to indicate that there are no representative inputs for the model.</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="generate_etrecord">
<a class="viewcode-back" href="../../../../etrecord.html#executorch.devtools.etrecord._etrecord.generate_etrecord">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_etrecord</span><span class="p">(</span>
    <span class="n">et_record</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">BinaryIO</span><span class="p">,</span> <span class="n">IO</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]],</span>
    <span class="n">edge_dialect_program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EdgeProgramManager</span><span class="p">,</span> <span class="n">ExirExportedProgram</span><span class="p">],</span>
    <span class="n">executorch_program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">ExecutorchProgram</span><span class="p">,</span>
        <span class="n">ExecutorchProgramManager</span><span class="p">,</span>
        <span class="n">BundledProgram</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">exported_program</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Union</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">]]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">extra_recorded_export_modules</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
        <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">ExportedProgram</span><span class="p">,</span>
                <span class="n">ExirExportedProgram</span><span class="p">,</span>
                <span class="n">EdgeProgramManager</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an `ETRecord` from the given objects, serializes it and saves it to the given path.</span>
<span class="sd">    The objects that will be serialized to an `ETRecord` are all the graph modules present</span>
<span class="sd">    in the `extra_recorded_export_modules` dict, the graph module present in the edge dialect program object,</span>
<span class="sd">    and also the graph module present in the ExecuTorch program object, which</span>
<span class="sd">    is the closest graph module representation of what is eventually run on the device.</span>
<span class="sd">    In addition to all the graph modules, we also serialize the program buffer, which the users</span>
<span class="sd">    can provide to the ExecuTorch runtime to run the model, and the debug handle map</span>
<span class="sd">    for Developer Tools usage.</span>

<span class="sd">    Args:</span>
<span class="sd">        et_record: Path to where the `ETRecord` file will be saved to.</span>
<span class="sd">        edge_dialect_program: `EdgeProgramManager` for this model returned by the call to to_edge()</span>
<span class="sd">        executorch_program: The ExecuTorch program for this model returned by the call to `to_executorch()` or the `BundledProgram` of this model</span>
<span class="sd">        exported_program: Optional graph module for this model returned by the call to `torch.export` from nn.Module.</span>
<span class="sd">        extra_recorded_export_modules [Optional]: **Should be ignored by OSS users**. A dictionary of graph modules with the key being the user provided name and the</span>
<span class="sd">            value being the corresponding exported module. The exported graph modules can be either the</span>
<span class="sd">            output of `torch.export()` or `exir.to_edge()`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">etrecord</span> <span class="o">=</span> <span class="n">ETRecord</span><span class="p">()</span>
    <span class="n">etrecord</span><span class="o">.</span><span class="n">add_exported_program</span><span class="p">(</span><span class="n">exported_program</span><span class="p">)</span>
    <span class="n">etrecord</span><span class="o">.</span><span class="n">add_edge_dialect_program</span><span class="p">(</span><span class="n">edge_dialect_program</span><span class="p">)</span>
    <span class="n">etrecord</span><span class="o">.</span><span class="n">add_executorch_program</span><span class="p">(</span><span class="n">executorch_program</span><span class="p">)</span>

    <span class="c1"># Add extra export modules if user provided</span>
    <span class="k">if</span> <span class="n">extra_recorded_export_modules</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">etrecord</span><span class="o">.</span><span class="n">add_extra_export_modules</span><span class="p">(</span><span class="n">extra_recorded_export_modules</span><span class="p">)</span>

    <span class="n">etrecord</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">et_record</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_process_exported_program</span><span class="p">(</span>
    <span class="n">exported_program</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process exported program and return the processed program and export graph id.&quot;&quot;&quot;</span>
    <span class="n">processed_exported_program</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">export_graph_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">exported_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exported_program</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;forward&quot;</span> <span class="ow">in</span> <span class="n">exported_program</span><span class="p">:</span>
            <span class="n">processed_exported_program</span> <span class="o">=</span> <span class="n">exported_program</span><span class="p">[</span><span class="s2">&quot;forward&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exported_program</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">):</span>
            <span class="n">processed_exported_program</span> <span class="o">=</span> <span class="n">exported_program</span>

        <span class="k">if</span> <span class="n">processed_exported_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">export_graph_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">processed_exported_program</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">processed_exported_program</span><span class="p">,</span> <span class="n">export_graph_id</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_validate_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that module name is not a reserved name.&quot;&quot;&quot;</span>
    <span class="n">contains_reserved_name</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">reserved_name</span> <span class="ow">in</span> <span class="n">module_name</span> <span class="k">for</span> <span class="n">reserved_name</span> <span class="ow">in</span> <span class="n">ETRecordReservedFileNames</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">contains_reserved_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The name </span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2"> provided in the extra_recorded_export_modules dict is a reserved name in the ETRecord namespace.&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_add_module_to_graph_map</span><span class="p">(</span>
    <span class="n">graph_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">],</span>
    <span class="n">module_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">export_module</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExportedProgram</span><span class="p">,</span> <span class="n">ExirExportedProgram</span><span class="p">,</span> <span class="n">EdgeProgramManager</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add export module to graph map based on its type.&quot;&quot;&quot;</span>
    <span class="n">_validate_module_name</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">export_module</span><span class="p">,</span> <span class="n">ExirExportedProgram</span><span class="p">):</span>
        <span class="n">graph_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">/forward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_module</span><span class="o">.</span><span class="n">exported_program</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">export_module</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">):</span>
        <span class="n">graph_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">/forward&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_module</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">export_module</span><span class="p">,</span>
        <span class="p">(</span><span class="n">EdgeProgramManager</span><span class="p">,</span> <span class="n">exir</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">_program</span><span class="o">.</span><span class="n">EdgeProgramManager</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">export_module</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="n">graph_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_module</span><span class="o">.</span><span class="n">exported_program</span><span class="p">(</span>
                <span class="n">method</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported graph module type. </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">export_module</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_process_edge_dialect_program</span><span class="p">(</span>
    <span class="n">edge_dialect_program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EdgeProgramManager</span><span class="p">,</span> <span class="n">ExirExportedProgram</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExportedProgram</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process edge dialect program and return the exported program.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">edge_dialect_program</span><span class="p">,</span>
        <span class="p">(</span><span class="n">EdgeProgramManager</span><span class="p">,</span> <span class="n">exir</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">_program</span><span class="o">.</span><span class="n">EdgeProgramManager</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">edge_dialect_program</span><span class="o">.</span><span class="n">exported_program</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edge_dialect_program</span><span class="p">,</span> <span class="n">ExirExportedProgram</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">edge_dialect_program</span><span class="o">.</span><span class="n">exported_program</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported type of edge_dialect_program passed in </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">edge_dialect_program</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_process_executorch_program</span><span class="p">(</span>
    <span class="n">executorch_program</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
        <span class="n">ExecutorchProgram</span><span class="p">,</span> <span class="n">ExecutorchProgramManager</span><span class="p">,</span> <span class="n">BundledProgram</span>
    <span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process executorch program and return debug maps and bundled program data.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">executorch_program</span><span class="p">,</span> <span class="n">BundledProgram</span><span class="p">):</span>
        <span class="n">reference_outputs</span> <span class="o">=</span> <span class="n">_get_reference_outputs</span><span class="p">(</span><span class="n">executorch_program</span><span class="p">)</span>
        <span class="n">representative_inputs</span> <span class="o">=</span> <span class="n">_get_representative_inputs</span><span class="p">(</span><span class="n">executorch_program</span><span class="p">)</span>
        <span class="c1"># pyre-ignore[16]: Item `None` of `typing.Union[None, exir.program._program.ExecutorchProgram, exir.program._program.ExecutorchProgramManager]` has no attribute `debug_handle_map`</span>
        <span class="n">debug_handle_map</span> <span class="o">=</span> <span class="n">executorch_program</span><span class="o">.</span><span class="n">executorch_program</span><span class="o">.</span><span class="n">debug_handle_map</span>
        <span class="c1"># pyre-ignore[16]: Item `None` of `typing.Union[None, exir.program._program.ExecutorchProgram, exir.program._program.ExecutorchProgramManager]` has no attribute `debug_handle_map`</span>
        <span class="n">delegate_map</span> <span class="o">=</span> <span class="n">executorch_program</span><span class="o">.</span><span class="n">executorch_program</span><span class="o">.</span><span class="n">delegate_map</span>
        <span class="c1"># pyre-ignore[16]: Item `None` of `typing.Union[None, exir.program._program.ExecutorchProgram, exir.program._program.ExecutorchProgramManager]` has no attribute `instruction_id_to_num_outs_map`</span>
        <span class="n">instruction_id_to_num_outs_map</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">executorch_program</span><span class="o">.</span><span class="n">executorch_program</span><span class="o">.</span><span class="n">instruction_id_to_num_outs_map</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">debug_handle_map</span><span class="p">,</span>
            <span class="n">delegate_map</span><span class="p">,</span>
            <span class="n">instruction_id_to_num_outs_map</span><span class="p">,</span>
            <span class="n">reference_outputs</span><span class="p">,</span>
            <span class="n">representative_inputs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">debug_handle_map</span> <span class="o">=</span> <span class="n">executorch_program</span><span class="o">.</span><span class="n">debug_handle_map</span>
        <span class="n">delegate_map</span> <span class="o">=</span> <span class="n">executorch_program</span><span class="o">.</span><span class="n">delegate_map</span>
        <span class="n">instruction_id_to_num_outs_map</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">executorch_program</span><span class="o">.</span><span class="n">instruction_id_to_num_outs_map</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">debug_handle_map</span><span class="p">,</span>
            <span class="n">delegate_map</span><span class="p">,</span>
            <span class="n">instruction_id_to_num_outs_map</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_etrecord</span><span class="p">(</span><span class="n">etrecord_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ETRecord</span><span class="p">:</span>  <span class="c1"># noqa: C901</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses an `ETRecord` file and returns an `ETRecord` object that contains the deserialized graph</span>
<span class="sd">    modules, program buffer, and a debug handle map.</span>
<span class="sd">    In the graph map in the returned `ETRecord` object if a model with multiple entry points was provided</span>
<span class="sd">    originally by the user during `ETRecord` generation then each entry point will be stored as a separate</span>
<span class="sd">    graph module in the `ETRecord` object with the name being `the original module name + &quot;/&quot; + the</span>
<span class="sd">    name of the entry point`.</span>

<span class="sd">    Args:</span>
<span class="sd">        etrecord_path: Path to the `ETRecord` file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        `ETRecord` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">etrecord_zip</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">etrecord_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadZipFile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid etrecord file passed in.&quot;</span><span class="p">)</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">ETRECORD_IDENTIFIER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;ETRecord identifier missing from etrecord file passed in. Either an invalid file was passed in or the file is corrupt.&quot;</span>
        <span class="p">)</span>

    <span class="n">graph_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ExportedProgram</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">debug_handle_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">delegate_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">instruction_id_to_num_outs_map</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exported_program</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">edge_dialect_program</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">reference_outputs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">representative_inputs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">export_graph_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">serialized_exported_program_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">serialized_state_dict_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">serialized_constants_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">serialized_example_inputs_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">DEBUG_HANDLE_MAP_NAME</span><span class="p">:</span>
            <span class="n">debug_handle_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">DEBUG_HANDLE_MAP_NAME</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">DELEGATE_MAP_NAME</span><span class="p">:</span>
            <span class="n">delegate_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">DELEGATE_MAP_NAME</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME</span><span class="p">:</span>
            <span class="n">instruction_id_to_num_outs_map</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">ETRECORD_IDENTIFIER</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EDGE_DIALECT_EXPORTED_PROGRAM</span><span class="p">:</span>
            <span class="n">serialized_artifact</span> <span class="o">=</span> <span class="n">SerializedArtifact</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EDGE_DIALECT_EXPORTED_PROGRAM</span>
                <span class="p">),</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">_state_dict&quot;</span><span class="p">),</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">_constants&quot;</span><span class="p">),</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">_example_inputs&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">edge_dialect_program</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">serialized_artifact</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EXPORTED_PROGRAM</span><span class="p">:</span>
            <span class="n">serialized_artifact</span> <span class="o">=</span> <span class="n">SerializedArtifact</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EXPORTED_PROGRAM</span><span class="p">),</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">_state_dict&quot;</span><span class="p">),</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">_constants&quot;</span><span class="p">),</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">_example_inputs&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">exported_program</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">serialized_artifact</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">REFERENCE_OUTPUTS</span><span class="p">:</span>
            <span class="c1"># @lint-ignore PYTHONPICKLEISBAD</span>
            <span class="n">reference_outputs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">REFERENCE_OUTPUTS</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">REPRESENTATIVE_INPUTS</span><span class="p">:</span>
            <span class="c1"># @lint-ignore PYTHONPICKLEISBAD</span>
            <span class="n">representative_inputs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">REPRESENTATIVE_INPUTS</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EXPORT_GRAPH_ID</span><span class="p">:</span>
            <span class="n">export_graph_id</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ETRecordReservedFileNames</span><span class="o">.</span><span class="n">EXPORT_GRAPH_ID</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;state_dict&quot;</span><span class="p">):</span>
                <span class="n">serialized_state_dict_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;constants&quot;</span><span class="p">):</span>
                <span class="n">serialized_constants_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;example_inputs&quot;</span><span class="p">):</span>
                <span class="n">serialized_example_inputs_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">serialized_exported_program_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">serialized_file</span> <span class="ow">in</span> <span class="n">serialized_exported_program_files</span><span class="p">:</span>
        <span class="n">serialized_state_dict_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">serialized_file</span><span class="si">}</span><span class="s2">_state_dict&quot;</span>
        <span class="n">serialized_constants_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">serialized_file</span><span class="si">}</span><span class="s2">_constants&quot;</span>
        <span class="n">serialized_example_inputs_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">serialized_file</span><span class="si">}</span><span class="s2">_example_inputs&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">serialized_state_dict_file</span> <span class="ow">in</span> <span class="n">serialized_state_dict_files</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Could not find corresponding state dict file for </span><span class="si">{</span><span class="n">serialized_file</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">serialized_artifact</span> <span class="o">=</span> <span class="n">SerializedArtifact</span><span class="p">(</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">serialized_file</span><span class="p">),</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">serialized_state_dict_file</span><span class="p">),</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">serialized_constants_file</span><span class="p">),</span>
            <span class="n">etrecord_zip</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">serialized_example_inputs_file</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">graph_map</span><span class="p">[</span><span class="n">serialized_file</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">serialized_artifact</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ETRecord</span><span class="p">(</span>
        <span class="n">exported_program</span><span class="o">=</span><span class="n">exported_program</span><span class="p">,</span>
        <span class="n">edge_dialect_program</span><span class="o">=</span><span class="n">edge_dialect_program</span><span class="p">,</span>
        <span class="n">graph_map</span><span class="o">=</span><span class="n">graph_map</span><span class="p">,</span>
        <span class="n">_debug_handle_map</span><span class="o">=</span><span class="n">debug_handle_map</span><span class="p">,</span>
        <span class="n">_delegate_map</span><span class="o">=</span><span class="n">delegate_map</span><span class="p">,</span>
        <span class="n">_instruction_id_to_num_outs_map</span><span class="o">=</span><span class="n">instruction_id_to_num_outs_map</span><span class="p">,</span>
        <span class="n">_reference_outputs</span><span class="o">=</span><span class="n">reference_outputs</span><span class="p">,</span>
        <span class="n">_representative_inputs</span><span class="o">=</span><span class="n">representative_inputs</span><span class="p">,</span>
        <span class="n">export_graph_id</span><span class="o">=</span><span class="n">export_graph_id</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>

                </article>
              
  </article>
  
              
              
                <footer class="bd-footer-article">
                  <div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item">
<div class="feedback">
  
<div class="rating">
    Rate this Page
    <div class="stars">
        
        <span class="star" data-behavior="tutorial-rating" data-count="1" data-value="1">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="2" data-value="2">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="3" data-value="3">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="4" data-value="4">★</span>
        
        <span class="star" data-behavior="tutorial-rating" data-count="5" data-value="5">★</span>
        
    </div>
</div>

  <div class="feedback-send">
    <button class="feedback-btn"
            onclick="openGitHubIssue()"
            data-bs-title="Create a GitHub Issue"
            data-bs-placement="bottom"
            data-bs-toggle="tooltip"
            data-gtm="feedback-btn-click">Send Feedback
    </button>
  </div>
</div>

<div class="prev-next-area">
</div>

<div class="footer-info">
  <p class="copyright">
    
  </p>

  <p class="theme-version">
    Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
  </p>
</div>
</div>
  
</div>
                </footer>
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  

<div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <h2>Docs</h2>
        <p>Access comprehensive developer documentation for PyTorch</p>
        <a class="with-right-arrow" href="https://docs.pytorch.org/docs/stable/index.html">View Docs</a>
      </div>

      <div class="col-md-4">
        <h2>Tutorials</h2>
        <p>Get in-depth tutorials for beginners and advanced developers</p>
        <a class="with-right-arrow" href="https://docs.pytorch.org/tutorials">View Tutorials</a>
      </div>

      <div class="col-md-4">
        <h2>Resources</h2>
        <p>Find development resources and get your questions answered</p>
        <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
      </div>
    </div>
  </div>
</div>




<footer class="site-footer">

  <div class="container footer-container">

    <div class="newsletter" id="newsletter">

      <p class="newsletter__title is-style-max-width-800"><strong>Stay in touch</strong> for updates, event info, and
        the latest news</p>


      <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/embed/v2.js"></script>
      <script>
        hbspt.forms.create({
          region: "na1",
          portalId: "8112310",
          formId: "2fb2231c-000b-4ec5-88a0-1ab242549c9e"
        });
      </script>


      <p class="newsletter__privacy">By submitting this form, I consent to receive marketing emails from the LF and its
        projects regarding their events, training, research, developments, and related announcements. I understand that
        I can unsubscribe at any time using the links in the footers of the emails I receive. <a
          href="https://www.linuxfoundation.org/privacy/">Privacy Policy</a>.</p>

    </div>

    <div class="lf-grid">
      <ul class="social-links">
        <li><a href="https://www.facebook.com/pytorch" target="_blank" title="PyTorch on Facebook">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="-0.51 -0.26 26.45 26.45" aria-label="Facebook">
              <path fill="currentColor"
                d="M25.497 13.075c0-2.45-.698-4.848-2.011-6.911a12.765 12.765 0 0 0-5.398-4.73A12.671 12.671 0 0 0 11.008.38a12.705 12.705 0 0 0-6.529 2.95A12.827 12.827 0 0 0 .563 9.358a12.896 12.896 0 0 0-.07 7.201 12.831 12.831 0 0 0 3.801 6.103 12.709 12.709 0 0 0 6.471 3.078v-8.957H7.53v-3.708h3.235v-2.824c0-3.213 1.903-4.988 4.813-4.988.956.014 1.909.097 2.852.25V8.67h-1.607a1.83 1.83 0 0 0-1.518.497 1.854 1.854 0 0 0-.561 1.505v2.404h3.535l-.563 3.708h-2.97v8.957a12.725 12.725 0 0 0 7.697-4.337 12.87 12.87 0 0 0 3.054-8.328z" />
            </svg>
          </a></li>
        <li><a href="https://twitter.com/pytorch" target="_blank" title="PyTorch on X">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 300 300" aria-label="X">
              <path fill="currentColor"
                d="M178.57 127.15 290.27 0h-26.46l-97.03 110.38L89.34 0H0l117.13 166.93L0 300.25h26.46l102.4-116.59 81.8 116.59h89.34M36.01 19.54H76.66l187.13 262.13h-40.66" />
            </svg>
          </a></li>
        <li><a href="https://www.youtube.com/pytorch" target="_blank" title="PyTorch on YouTube">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="0.21 0.27 34.45 25.07" aria-label="YouTube">
              <path fill="currentColor"
                d="M33.729 6.084s-.327-2.33-1.317-3.356a4.691 4.691 0 0 0-3.32-1.432c-4.634-.34-11.589-.34-11.589-.34h-.014s-6.954 0-11.59.342a4.692 4.692 0 0 0-3.32 1.432c-.993 1.025-1.315 3.354-1.315 3.354a52.189 52.189 0 0 0-.331 5.473v2.566c.014 1.829.125 3.656.331 5.472 0 0 .322 2.33 1.316 3.36 1.26 1.345 2.916 1.3 3.653 1.445 2.65.26 11.263.34 11.263.34s6.96-.01 11.597-.353a4.691 4.691 0 0 0 3.32-1.432c.993-1.026 1.316-3.356 1.316-3.356.206-1.817.316-3.644.33-5.473v-2.57a52.26 52.26 0 0 0-.33-5.472zM14.076 17.232V7.729l8.951 4.768-8.95 4.735z" />
            </svg>
          </a></li>
        <li><a href="https://www.linkedin.com/company/pytorch" target="_blank" title="PyTorch on LinkedIn">
            <svg xmlns="http://www.w3.org/2000/svg" viewbox="-10.23 -10.23 531.96 531.96" aria-label="LinkedIn">
              <rect width="512" height="512" rx="0" fill="currentColor" />
              <circle fill="#000" cx="142" cy="138" r="37" />
              <path stroke="#000" stroke-width="66" d="M244 194v198M142 194v198" />
              <path fill="#000"
                d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32" />
            </svg>
          </a></li>
        <li><a href="https://pytorch.slack.com" target="_blank" title="PyTorch Slack">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0.16 -0.03 21.19 21.19" aria-label="Slack">
              <path fill="currentColor"
                d="M4.896 13.27a2.147 2.147 0 0 1-2.141 2.142A2.147 2.147 0 0 1 .613 13.27c0-1.178.963-2.141 2.142-2.141h2.141v2.141zm1.08 0c0-1.178.962-2.141 2.141-2.141s2.142.963 2.142 2.141v5.363a2.147 2.147 0 0 1-2.142 2.141 2.147 2.147 0 0 1-2.141-2.142V13.27zm2.141-8.6a2.147 2.147 0 0 1-2.141-2.14c0-1.18.962-2.142 2.141-2.142s2.142.963 2.142 2.141v2.142H8.117zm0 1.08c1.179 0 2.141.962 2.141 2.141a2.147 2.147 0 0 1-2.141 2.142H2.755A2.147 2.147 0 0 1 .613 7.89c0-1.179.963-2.141 2.142-2.141h5.362zm8.599 2.141c0-1.179.963-2.141 2.141-2.141 1.179 0 2.143.962 2.143 2.14a2.147 2.147 0 0 1-2.142 2.142h-2.141V7.89zm-1.08 0a2.147 2.147 0 0 1-2.141 2.142 2.147 2.147 0 0 1-2.141-2.142V2.53c0-1.178.962-2.141 2.141-2.141s2.142.963 2.142 2.141v5.362zm-2.141 8.6c1.179 0 2.142.962 2.142 2.14a2.147 2.147 0 0 1-2.142 2.142 2.147 2.147 0 0 1-2.141-2.141V16.49h2.141zm0-1.08a2.147 2.147 0 0 1-2.141-2.141c0-1.179.962-2.142 2.141-2.142h5.362c1.179 0 2.142.963 2.142 2.142a2.147 2.147 0 0 1-2.142 2.142h-5.362z">
              </path>
            </svg>
          </a></li>
        <li><a href="https://pytorch.org/wechat" title="PyTorch on WeChat">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0.14 -0.17 38.02 33.02" aria-label="WeChat">
              <path fill="currentColor"
                d="M26.289 10.976a12.972 12.972 0 0 0-8.742 3.53 10.386 10.386 0 0 0-3.224 8.795c-1.326-.164-2.535-.345-3.75-.448a2.332 2.332 0 0 0-1.273.216c-1.18.666-2.311 1.418-3.652 2.255.246-1.112.405-2.087.687-3.024a1.15 1.15 0 0 0-.523-1.52C1.737 17.902.02 13.601 1.307 9.165c1.189-4.1 4.11-6.587 8.077-7.884A13.54 13.54 0 0 1 24.18 5.617a10.135 10.135 0 0 1 2.109 5.359zM10.668 9.594a1.564 1.564 0 0 0-2.095-1.472 1.52 1.52 0 0 0-.895 1.964 1.502 1.502 0 0 0 1.391.966 1.545 1.545 0 0 0 1.598-1.46v.002zm8.15-1.566a1.567 1.567 0 0 0-1.528 1.543 1.528 1.528 0 0 0 1.571 1.492 1.52 1.52 0 0 0 1.375-2.117 1.518 1.518 0 0 0-1.415-.919l-.003.001z">
              </path>
              <path fill="currentColor"
                d="M33.914 32.137c-1.075-.478-2.062-1.196-3.11-1.306-1.049-.11-2.145.494-3.24.605a10.821 10.821 0 0 1-8.781-2.864c-4.682-4.33-4.013-10.97 1.403-14.518 4.811-3.154 11.874-2.102 15.268 2.273a8.671 8.671 0 0 1-1.002 12.095c-1.046.929-1.422 1.693-.751 2.917.102.257.174.525.213.798zM21.68 20.292a1.264 1.264 0 1 0 .01-2.528 1.264 1.264 0 0 0-.01 2.528zm7.887-2.526a1.266 1.266 0 0 0-1.256 1.21 1.247 1.247 0 1 0 1.256-1.21z">
              </path>
            </svg>
          </a></li>
      </ul>
    </div>
    
    <div class="privacy-policy">
      <div class="copyright">
      
        <p>
          &copy; PyTorch. Copyright © The Linux Foundation®. All rights reserved. The Linux Foundation has registered
          trademarks and uses trademarks. For more information, including terms of use, privacy policy, and trademark
          usage, please see our <a href="https://www.linuxfoundation.org/legal/policies">Policies</a> page. <a
            href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a>. <a
            href="http://www.linuxfoundation.org/privacy">Privacy Policy</a>.
        </p>
        
      </div>
    </div>


  </div>
</footer>

<div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/img/pytorch-x.svg">
  </div>
</div>
  
  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, ExecuTorch.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  <script type="application/ld+json">
    {
       "@context": "https://schema.org",
       "@type": "Article",
       "name": "executorch.devtools.etrecord._etrecord",
       "headline": "executorch.devtools.etrecord._etrecord",
       "description": "PyTorch Documentation. Explore PyTorch, an open-source machine learning library that accelerates the path from research prototyping to production deployment. Discover tutorials, API references, and guides to help you build and deploy deep learning models efficiently.",
       "url": "/_modules/executorch/devtools/etrecord/_etrecord.html",
       "articleBody": "Source code for executorch.devtools.etrecord._etrecord # Copyright (c) Meta Platforms, Inc. and affiliates. # All rights reserved. # # This source code is licensed under the BSD-style license found in the # LICENSE file in the root directory of this source tree. # pyre-unsafe import json import os import pickle from typing import BinaryIO, Dict, IO, List, Optional, Union from zipfile import BadZipFile, ZipFile import torch from executorch import exir from executorch.devtools.bundled_program.config import ConfigValue from executorch.devtools.bundled_program.core import BundledProgram from executorch.exir import ( EdgeProgramManager, ExecutorchProgram, ExecutorchProgramManager, ExirExportedProgram, ExportedProgram, ) from executorch.exir.emit._emitter import _DelegateDebugIdentifierMap from executorch.exir.serde.export_serialize import SerializedArtifact from executorch.exir.serde.serialize import deserialize, serialize ProgramInput = ConfigValue ProgramOutput = torch.Tensor try: # breaking change introduced in python 3.11 # pyre-ignore from enum import StrEnum except ImportError: from enum import Enum class StrEnum(str, Enum): pass class ETRecordReservedFileNames(StrEnum): ETRECORD_IDENTIFIER = \"ETRECORD_V0\" EXPORTED_PROGRAM = \"exported_program\" EXPORT_GRAPH_ID = \"export_graph_id\" EDGE_DIALECT_EXPORTED_PROGRAM = \"edge_dialect_exported_program\" ET_DIALECT_GRAPH_MODULE = \"et_dialect_graph_module\" DEBUG_HANDLE_MAP_NAME = \"debug_handle_map\" DELEGATE_MAP_NAME = \"delegate_map\" INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME = \"instruction_id_to_num_outs_map\" REFERENCE_OUTPUTS = \"reference_outputs\" REPRESENTATIVE_INPUTS = \"representative_inputs\" class ETRecord: def __init__( self, exported_program: Optional[ExportedProgram] = None, export_graph_id: Optional[int] = None, edge_dialect_program: Optional[ExportedProgram] = None, graph_map: Optional[Dict[str, ExportedProgram]] = None, _debug_handle_map: Optional[Dict[int, Union[int, List[int]]]] = None, _delegate_map: Optional[ Dict[str, Dict[int, Dict[str, Union[str, _DelegateDebugIdentifierMap]]]] ] = None, _instruction_id_to_num_outs_map: Optional[ Dict[str, Dict[int, Union[int, List[int]]]] ] = None, _reference_outputs: Optional[Dict[str, List[ProgramOutput]]] = None, _representative_inputs: Optional[List[ProgramInput]] = None, ): \"\"\" Please do not construct an ETRecord object directly. If you want to create an ETRecord for logging AOT information to further analysis, please mark `generate_etrecord` as True in your export api, and get the ETRecord object from the `ExecutorchProgramManager`. For exmaple: ```python exported_program = torch.export.export(model, inputs) edge_program = to_edge_transform_and_lower(exported_program, generate_etrecord=True) executorch_program = edge_program.to_executorch() etrecord = executorch_program.get_etrecord() ``` If user need to create an ETRecord manually, please use the `create_etrecord` function. \"\"\" self.exported_program = exported_program self.export_graph_id = export_graph_id self.edge_dialect_program = edge_dialect_program self.graph_map = graph_map self._debug_handle_map = _debug_handle_map self._delegate_map = _delegate_map self._instruction_id_to_num_outs_map = _instruction_id_to_num_outs_map self._reference_outputs = _reference_outputs self._representative_inputs = _representative_inputs def save(self, path: Union[str, os.PathLike, BinaryIO, IO[bytes]]) -\u003e None: \"\"\" Serialize and save the ETRecord to the specified path for use in Inspector. The ETRecord should contains at least edge dialect program and executorch program information for further analysis, otherwise it will raise an exception. Args: path: Path where the ETRecord file will be saved to. Raises: RuntimeError: If the ETRecord does not contain essential information for Inpector. \"\"\" if isinstance(path, (str, os.PathLike)): # pyre-ignore[6]: In call `os.fspath`, for 1st positional argument, expected `str` but got `Union[PathLike[typing.Any], str]` path = os.fspath(path) if not (self.edge_dialect_program and self._debug_handle_map): raise RuntimeError( \"ETRecord must contain edge dialect program and executorch program to be saved\" ) etrecord_zip = ZipFile(path, \"w\") try: self._write_identifier(etrecord_zip) self._save_programs(etrecord_zip) self._save_graph_map(etrecord_zip) self._save_metadata(etrecord_zip) finally: etrecord_zip.close() def _write_identifier(self, etrecord_zip: ZipFile) -\u003e None: \"\"\"Write the magic file identifier.\"\"\" etrecord_zip.writestr(ETRecordReservedFileNames.ETRECORD_IDENTIFIER, \"\") def _save_programs(self, etrecord_zip: ZipFile) -\u003e None: \"\"\"Save exported program and edge dialect program.\"\"\" if self.exported_program is not None: self._save_exported_program( etrecord_zip, ETRecordReservedFileNames.EXPORTED_PROGRAM, \"\", self.exported_program, ) if self.edge_dialect_program is not None: self._save_edge_dialect_program(etrecord_zip, self.edge_dialect_program) def _save_graph_map(self, etrecord_zip: ZipFile) -\u003e None: \"\"\"Save graph map if present.\"\"\" if self.graph_map is not None: # pyre-ignore[16]: Undefined attribute [16]: `Optional` has no attribute `items`. for module_name, export_module in self.graph_map.items(): if \"/\" in module_name: base_name, method_name = module_name.rsplit(\"/\", 1) self._save_exported_program( etrecord_zip, base_name, method_name, export_module ) else: self._save_exported_program( etrecord_zip, module_name, \"forward\", export_module ) def _save_metadata(self, etrecord_zip: ZipFile) -\u003e None: \"\"\"Save debug maps, reference outputs, and other metadata.\"\"\" if self._debug_handle_map is not None: etrecord_zip.writestr( ETRecordReservedFileNames.DEBUG_HANDLE_MAP_NAME, json.dumps(self._debug_handle_map), ) if self._delegate_map is not None: etrecord_zip.writestr( ETRecordReservedFileNames.DELEGATE_MAP_NAME, json.dumps(self._delegate_map), ) if self._instruction_id_to_num_outs_map is not None: etrecord_zip.writestr( ETRecordReservedFileNames.INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME, json.dumps(self._instruction_id_to_num_outs_map), ) if self._reference_outputs is not None: etrecord_zip.writestr( ETRecordReservedFileNames.REFERENCE_OUTPUTS, pickle.dumps(self._reference_outputs), ) if self._representative_inputs is not None: etrecord_zip.writestr( ETRecordReservedFileNames.REPRESENTATIVE_INPUTS, pickle.dumps(self._representative_inputs), ) if self.export_graph_id is not None: etrecord_zip.writestr( ETRecordReservedFileNames.EXPORT_GRAPH_ID, json.dumps(self.export_graph_id), ) def _save_exported_program( self, etrecord_zip: ZipFile, module_name: str, method_name: str, ep: ExportedProgram, ) -\u003e None: \"\"\"Save an exported program to the ETRecord zip file.\"\"\" serialized_artifact = serialize(ep) assert isinstance(serialized_artifact.exported_program, bytes) method_name = f\"/{method_name}\" if method_name != \"\" else \"\" base_name = f\"{module_name}{method_name}\" etrecord_zip.writestr(base_name, serialized_artifact.exported_program) etrecord_zip.writestr(f\"{base_name}_state_dict\", serialized_artifact.state_dict) etrecord_zip.writestr(f\"{base_name}_constants\", serialized_artifact.constants) etrecord_zip.writestr( f\"{base_name}_example_inputs\", serialized_artifact.example_inputs ) def _save_edge_dialect_program( self, etrecord_zip: ZipFile, edge_dialect_program: ExportedProgram ) -\u003e None: \"\"\"Save the edge dialect program to the ETRecord zip file.\"\"\" serialized_artifact = serialize(edge_dialect_program) assert isinstance(serialized_artifact.exported_program, bytes) base_name = ETRecordReservedFileNames.EDGE_DIALECT_EXPORTED_PROGRAM etrecord_zip.writestr(base_name, serialized_artifact.exported_program) etrecord_zip.writestr(f\"{base_name}_state_dict\", serialized_artifact.state_dict) etrecord_zip.writestr(f\"{base_name}_constants\", serialized_artifact.constants) etrecord_zip.writestr( f\"{base_name}_example_inputs\", serialized_artifact.example_inputs ) def add_extra_export_modules( self, extra_recorded_export_modules: Dict[ str, Union[ ExportedProgram, ExirExportedProgram, EdgeProgramManager, ], ], ) -\u003e None: \"\"\" Add extra export modules to the ETRecord after it has been created. This method allows users to add more export modules they want to record to an existing ETRecord instance. The modules will be added to the graph_map and will be included when the ETRecord is saved. Args: extra_recorded_export_modules: A dictionary of graph modules with the key being the user provided name and the value being the corresponding exported module. The exported graph modules can be either the output of `torch.export()` or `exir.to_edge()`. \"\"\" if self.graph_map is None: self.graph_map = {} # Now self.graph_map is guaranteed to be non-None graph_map = self.graph_map for module_name, export_module in extra_recorded_export_modules.items(): _add_module_to_graph_map(graph_map, module_name, export_module) def add_executorch_program( self, executorch_program: Union[ ExecutorchProgram, ExecutorchProgramManager, BundledProgram, ], ) -\u003e None: \"\"\" Add executorch program data to the ETRecord after it has been created. This method allows users to add executorch program data they want to record to an existing ETRecord instance. The executorch program data includes debug handle map, delegate map, reference outputs, and representative inputs that will be included when the ETRecord is saved. Args: executorch_program: The ExecuTorch program for this model returned by the call to `to_executorch()` or the `BundledProgram` of this model. Raises: RuntimeError: If executorch program data already exists in the ETRecord. \"\"\" # Check if executorch program data already exists if ( self._debug_handle_map is not None or self._delegate_map is not None or self._instruction_id_to_num_outs_map is not None or self._reference_outputs is not None or self._representative_inputs is not None ): raise RuntimeError( \"Executorch program data already exists in the ETRecord. \" \"Cannot add executorch program data when it already exists.\" ) # Process executorch program and extract data ( debug_handle_map, delegate_map, instruction_id_to_num_outs_map, reference_outputs, representative_inputs, ) = _process_executorch_program(executorch_program) # Set the extracted data self._debug_handle_map = debug_handle_map self._delegate_map = delegate_map self._instruction_id_to_num_outs_map = instruction_id_to_num_outs_map self._reference_outputs = reference_outputs self._representative_inputs = representative_inputs def add_exported_program( self, exported_program: Optional[Union[ExportedProgram, Dict[str, ExportedProgram]]], ) -\u003e None: \"\"\" Add exported program to the ETRecord after it has been created. This method allows users to add an exported program they want to record to an existing ETRecord instance. The exported program will be included when the ETRecord is saved. Args: exported_program: The exported program for this model returned by the call to `torch.export()` or a dictionary with method names as keys and exported programs as values. Can be None, in which case no exported program data will be added. Raises: RuntimeError: If exported program already exists in the ETRecord. \"\"\" # Check if exported program already exists if self.exported_program is not None or self.export_graph_id is not None: raise RuntimeError( \"Exported program already exists in the ETRecord. \" \"Cannot add exported program when it already exists.\" ) # Process exported program and extract data processed_exported_program, export_graph_id = _process_exported_program( exported_program ) # Set the extracted data self.exported_program = processed_exported_program self.export_graph_id = export_graph_id def add_edge_dialect_program( self, edge_dialect_program: Union[EdgeProgramManager, ExirExportedProgram], ) -\u003e None: \"\"\" Add edge dialect program to the ETRecord after it has been created. This method allows users to add an edge dialect program they want to record to an existing ETRecord instance. The edge dialect program will be included when the ETRecord is saved. Args: edge_dialect_program: The edge dialect program for this model returned by the call to `to_edge()` or `EdgeProgramManager` for this model. Raises: RuntimeError: If edge dialect program already exists in the ETRecord. \"\"\" # Check if edge dialect program already exists if self.edge_dialect_program is not None: raise RuntimeError( \"Edge dialect program already exists in the ETRecord. \" \"Cannot add edge dialect program when it already exists.\" ) # Process edge dialect program and extract data processed_edge_dialect_program = _process_edge_dialect_program( edge_dialect_program ) # Set the extracted data self.edge_dialect_program = processed_edge_dialect_program def update_representative_inputs( self, representative_inputs: Union[List[ProgramInput], BundledProgram], ) -\u003e None: \"\"\" Update the representative inputs in the ETRecord. This method allows users to customize the representative inputs that will be included when the ETRecord is saved. The representative inputs can be provided directly as a list or extracted from a BundledProgram. Args: representative_inputs: Either a list of ProgramInput objects or a BundledProgram from which representative inputs will be extracted. \"\"\" if isinstance(representative_inputs, BundledProgram): self._representative_inputs = _get_representative_inputs( representative_inputs ) else: self._representative_inputs = representative_inputs def update_reference_outputs( self, reference_outputs: Union[ Dict[str, List[ProgramOutput]], List[ProgramOutput], BundledProgram ], ) -\u003e None: \"\"\" Update the reference outputs in the ETRecord. This method allows users to customize the reference outputs that will be included when the ETRecord is saved. The reference outputs can be provided directly as a dictionary mapping method names to lists of outputs, as a single list of outputs (which will be treated as {\"forward\": List[ProgramOutput]}), or extracted from a BundledProgram. Args: reference_outputs: Either a dictionary mapping method names to lists of ProgramOutput objects, a single list of ProgramOutput objects (treated as outputs for the \"forward\" method), or a BundledProgram from which reference outputs will be extracted. \"\"\" if isinstance(reference_outputs, BundledProgram): self._reference_outputs = _get_reference_outputs(reference_outputs) elif isinstance(reference_outputs, list): self._reference_outputs = {\"forward\": reference_outputs} else: self._reference_outputs = reference_outputs def _get_reference_outputs( bundled_program: BundledProgram, ) -\u003e Dict[str, List[ProgramOutput]]: \"\"\" Extracts out the expected outputs from the bundled program, keyed by the method names. \"\"\" reference_outputs = {} for method_test_suite in bundled_program.method_test_suites: reference_outputs[method_test_suite.method_name] = [] for test_case in method_test_suite.test_cases: if not test_case.expected_outputs: raise ValueError( f\"Missing at least one set of expected outputs for method {method_test_suite.method_name}.\" ) reference_outputs[method_test_suite.method_name].append( test_case.expected_outputs ) return reference_outputs def _get_representative_inputs( bundled_program: BundledProgram, ) -\u003e Optional[List[ProgramInput]]: \"\"\" Extracts out the inputs from the bundled program, keyed by the method names. \"\"\" for method_test_suite in bundled_program.method_test_suites: if method_test_suite.method_name == \"forward\": if not method_test_suite.test_cases: raise ValueError( \"The \u0027forward\u0027 method is defined, but no corresponding input test cases are provided.\" ) # Get first example input from the forward method test_case = method_test_suite.test_cases[0] return test_case.inputs # If the forward method is not defined, return None to indicate that there are no representative inputs for the model. return None [docs] def generate_etrecord( et_record: Union[str, os.PathLike, BinaryIO, IO[bytes]], edge_dialect_program: Union[EdgeProgramManager, ExirExportedProgram], executorch_program: Union[ ExecutorchProgram, ExecutorchProgramManager, BundledProgram, ], exported_program: Optional[ Union[ExportedProgram, Dict[str, ExportedProgram]] ] = None, extra_recorded_export_modules: Optional[ Dict[ str, Union[ ExportedProgram, ExirExportedProgram, EdgeProgramManager, ], ] ] = None, ) -\u003e None: \"\"\" Generates an `ETRecord` from the given objects, serializes it and saves it to the given path. The objects that will be serialized to an `ETRecord` are all the graph modules present in the `extra_recorded_export_modules` dict, the graph module present in the edge dialect program object, and also the graph module present in the ExecuTorch program object, which is the closest graph module representation of what is eventually run on the device. In addition to all the graph modules, we also serialize the program buffer, which the users can provide to the ExecuTorch runtime to run the model, and the debug handle map for Developer Tools usage. Args: et_record: Path to where the `ETRecord` file will be saved to. edge_dialect_program: `EdgeProgramManager` for this model returned by the call to to_edge() executorch_program: The ExecuTorch program for this model returned by the call to `to_executorch()` or the `BundledProgram` of this model exported_program: Optional graph module for this model returned by the call to `torch.export` from nn.Module. extra_recorded_export_modules [Optional]: **Should be ignored by OSS users**. A dictionary of graph modules with the key being the user provided name and the value being the corresponding exported module. The exported graph modules can be either the output of `torch.export()` or `exir.to_edge()`. Returns: None \"\"\" etrecord = ETRecord() etrecord.add_exported_program(exported_program) etrecord.add_edge_dialect_program(edge_dialect_program) etrecord.add_executorch_program(executorch_program) # Add extra export modules if user provided if extra_recorded_export_modules is not None: etrecord.add_extra_export_modules(extra_recorded_export_modules) etrecord.save(et_record) def _process_exported_program( exported_program: Optional[Union[ExportedProgram, Dict[str, ExportedProgram]]] ) -\u003e tuple[Optional[ExportedProgram], Optional[int]]: \"\"\"Process exported program and return the processed program and export graph id.\"\"\" processed_exported_program = None export_graph_id = None if exported_program is not None: if isinstance(exported_program, dict) and \"forward\" in exported_program: processed_exported_program = exported_program[\"forward\"] elif isinstance(exported_program, ExportedProgram): processed_exported_program = exported_program if processed_exported_program is not None: export_graph_id = id(processed_exported_program.graph) return processed_exported_program, export_graph_id def _validate_module_name(module_name: str) -\u003e None: \"\"\"Validate that module name is not a reserved name.\"\"\" contains_reserved_name = any( reserved_name in module_name for reserved_name in ETRecordReservedFileNames ) if contains_reserved_name: raise RuntimeError( f\"The name {module_name} provided in the extra_recorded_export_modules dict is a reserved name in the ETRecord namespace.\" ) def _add_module_to_graph_map( graph_map: Dict[str, ExportedProgram], module_name: str, export_module: Union[ExportedProgram, ExirExportedProgram, EdgeProgramManager], ) -\u003e None: \"\"\"Add export module to graph map based on its type.\"\"\" _validate_module_name(module_name) if isinstance(export_module, ExirExportedProgram): graph_map[f\"{module_name}/forward\"] = export_module.exported_program elif isinstance(export_module, ExportedProgram): graph_map[f\"{module_name}/forward\"] = export_module elif isinstance( export_module, (EdgeProgramManager, exir.program._program.EdgeProgramManager), ): for method in export_module.methods: graph_map[f\"{module_name}/{method}\"] = export_module.exported_program( method ) else: raise RuntimeError(f\"Unsupported graph module type. {type(export_module)}\") def _process_edge_dialect_program( edge_dialect_program: Union[EdgeProgramManager, ExirExportedProgram] ) -\u003e ExportedProgram: \"\"\"Process edge dialect program and return the exported program.\"\"\" if isinstance( edge_dialect_program, (EdgeProgramManager, exir.program._program.EdgeProgramManager), ): return edge_dialect_program.exported_program() elif isinstance(edge_dialect_program, ExirExportedProgram): return edge_dialect_program.exported_program else: raise RuntimeError( f\"Unsupported type of edge_dialect_program passed in {type(edge_dialect_program)}.\" ) def _process_executorch_program( executorch_program: Union[ ExecutorchProgram, ExecutorchProgramManager, BundledProgram ] ) -\u003e tuple[ Optional[Dict], Optional[Dict], Optional[Dict], Optional[Dict], Optional[List] ]: \"\"\"Process executorch program and return debug maps and bundled program data.\"\"\" if isinstance(executorch_program, BundledProgram): reference_outputs = _get_reference_outputs(executorch_program) representative_inputs = _get_representative_inputs(executorch_program) # pyre-ignore[16]: Item `None` of `typing.Union[None, exir.program._program.ExecutorchProgram, exir.program._program.ExecutorchProgramManager]` has no attribute `debug_handle_map` debug_handle_map = executorch_program.executorch_program.debug_handle_map # pyre-ignore[16]: Item `None` of `typing.Union[None, exir.program._program.ExecutorchProgram, exir.program._program.ExecutorchProgramManager]` has no attribute `debug_handle_map` delegate_map = executorch_program.executorch_program.delegate_map # pyre-ignore[16]: Item `None` of `typing.Union[None, exir.program._program.ExecutorchProgram, exir.program._program.ExecutorchProgramManager]` has no attribute `instruction_id_to_num_outs_map` instruction_id_to_num_outs_map = ( executorch_program.executorch_program.instruction_id_to_num_outs_map ) return ( debug_handle_map, delegate_map, instruction_id_to_num_outs_map, reference_outputs, representative_inputs, ) else: debug_handle_map = executorch_program.debug_handle_map delegate_map = executorch_program.delegate_map instruction_id_to_num_outs_map = ( executorch_program.instruction_id_to_num_outs_map ) return ( debug_handle_map, delegate_map, instruction_id_to_num_outs_map, None, None, ) def parse_etrecord(etrecord_path: str) -\u003e ETRecord: # noqa: C901 \"\"\" Parses an `ETRecord` file and returns an `ETRecord` object that contains the deserialized graph modules, program buffer, and a debug handle map. In the graph map in the returned `ETRecord` object if a model with multiple entry points was provided originally by the user during `ETRecord` generation then each entry point will be stored as a separate graph module in the `ETRecord` object with the name being `the original module name + \"/\" + the name of the entry point`. Args: etrecord_path: Path to the `ETRecord` file. Returns: `ETRecord` object. \"\"\" try: etrecord_zip = ZipFile(etrecord_path, \"r\") except BadZipFile: raise RuntimeError(\"Invalid etrecord file passed in.\") file_list = etrecord_zip.namelist() if ETRecordReservedFileNames.ETRECORD_IDENTIFIER not in file_list: raise RuntimeError( \"ETRecord identifier missing from etrecord file passed in. Either an invalid file was passed in or the file is corrupt.\" ) graph_map: Dict[str, ExportedProgram] = {} debug_handle_map = None delegate_map = None instruction_id_to_num_outs_map = None exported_program = None edge_dialect_program = None reference_outputs = None representative_inputs = None export_graph_id = 0 serialized_exported_program_files = set() serialized_state_dict_files = set() serialized_constants_files = set() serialized_example_inputs_files = set() for entry in file_list: if entry == ETRecordReservedFileNames.DEBUG_HANDLE_MAP_NAME: debug_handle_map = json.loads( etrecord_zip.read(ETRecordReservedFileNames.DEBUG_HANDLE_MAP_NAME) ) elif entry == ETRecordReservedFileNames.DELEGATE_MAP_NAME: delegate_map = json.loads( etrecord_zip.read(ETRecordReservedFileNames.DELEGATE_MAP_NAME) ) elif entry == ETRecordReservedFileNames.INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME: instruction_id_to_num_outs_map = json.loads( etrecord_zip.read( ETRecordReservedFileNames.INSTRUCTION_ID_TO_NUM_OUTS_MAP_NAME ) ) elif entry == ETRecordReservedFileNames.ETRECORD_IDENTIFIER: continue elif entry == ETRecordReservedFileNames.EDGE_DIALECT_EXPORTED_PROGRAM: serialized_artifact = SerializedArtifact( etrecord_zip.read( ETRecordReservedFileNames.EDGE_DIALECT_EXPORTED_PROGRAM ), etrecord_zip.read(f\"{entry}_state_dict\"), etrecord_zip.read(f\"{entry}_constants\"), etrecord_zip.read(f\"{entry}_example_inputs\"), ) edge_dialect_program = deserialize(serialized_artifact) elif entry == ETRecordReservedFileNames.EXPORTED_PROGRAM: serialized_artifact = SerializedArtifact( etrecord_zip.read(ETRecordReservedFileNames.EXPORTED_PROGRAM), etrecord_zip.read(f\"{entry}_state_dict\"), etrecord_zip.read(f\"{entry}_constants\"), etrecord_zip.read(f\"{entry}_example_inputs\"), ) exported_program = deserialize(serialized_artifact) elif entry == ETRecordReservedFileNames.REFERENCE_OUTPUTS: # @lint-ignore PYTHONPICKLEISBAD reference_outputs = pickle.loads( etrecord_zip.read(ETRecordReservedFileNames.REFERENCE_OUTPUTS) ) elif entry == ETRecordReservedFileNames.REPRESENTATIVE_INPUTS: # @lint-ignore PYTHONPICKLEISBAD representative_inputs = pickle.loads( etrecord_zip.read(ETRecordReservedFileNames.REPRESENTATIVE_INPUTS) ) elif entry == ETRecordReservedFileNames.EXPORT_GRAPH_ID: export_graph_id = json.loads( etrecord_zip.read(ETRecordReservedFileNames.EXPORT_GRAPH_ID) ) else: if entry.endswith(\"state_dict\"): serialized_state_dict_files.add(entry) elif entry.endswith(\"constants\"): serialized_constants_files.add(entry) elif entry.endswith(\"example_inputs\"): serialized_example_inputs_files.add(entry) else: serialized_exported_program_files.add(entry) for serialized_file in serialized_exported_program_files: serialized_state_dict_file = f\"{serialized_file}_state_dict\" serialized_constants_file = f\"{serialized_file}_constants\" serialized_example_inputs_file = f\"{serialized_file}_example_inputs\" assert ( serialized_state_dict_file in serialized_state_dict_files ), f\"Could not find corresponding state dict file for {serialized_file}.\" serialized_artifact = SerializedArtifact( etrecord_zip.read(serialized_file), etrecord_zip.read(serialized_state_dict_file), etrecord_zip.read(serialized_constants_file), etrecord_zip.read(serialized_example_inputs_file), ) graph_map[serialized_file] = deserialize(serialized_artifact) return ETRecord( exported_program=exported_program, edge_dialect_program=edge_dialect_program, graph_map=graph_map, _debug_handle_map=debug_handle_map, _delegate_map=delegate_map, _instruction_id_to_num_outs_map=instruction_id_to_num_outs_map, _reference_outputs=reference_outputs, _representative_inputs=representative_inputs, export_graph_id=export_graph_id, )",
       "author": {
         "@type": "Organization",
         "name": "PyTorch Contributors",
         "url": "https://pytorch.org"
       },
       "image": "https://pytorch.org/docs/stable/_static/img/pytorch_seo.png",
       "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "/_modules/executorch/devtools/etrecord/_etrecord.html"
       },
       "datePublished": "2023-01-01T00:00:00Z",
       "dateModified": "2023-01-01T00:00:00Z"
     }
 </script>
  <script>
    // Tutorials Call to action event tracking
    $("[data-behavior='call-to-action-event']").on('click', function () {
      fbq('trackCustom', "Download", {
        tutorialTitle: $('h1:first').text(),
        downloadLink: this.href,
        tutorialLink: window.location.href,
        downloadTitle: $(this).attr("data-response")
      });
      if (typeof gtag === 'function') {
        gtag('event', 'click', {
          'event_category': $(this).attr("data-response"),
          'event_label': $("h1").first().text(),
          'tutorial_link': window.location.href
        });
      }
    });
  </script>
  
  </body>
</html>