#!/usr/bin/env bash

# Pre-commit hook to automatically update PyTorch commit pin when torch_pin.py changes

# Check if torch_pin.py is being committed
if git diff --cached --name-only | grep -q "^torch_pin.py$"; then
    echo "üîç Detected changes to torch_pin.py"
    echo "üìù Updating PyTorch commit pin..."

    # Run the update script
    hook_output=$(python .github/scripts/update_pytorch_pin.py 2>&1)
    hook_status=$?
    echo "$hook_output"

    if [ $hook_status -eq 0 ]; then
        # Check if pytorch.txt was modified
        if ! git diff --quiet .ci/docker/ci_commit_pins/pytorch.txt; then
            echo "‚úÖ PyTorch commit pin updated successfully"
            # Stage the updated file
            git add .ci/docker/ci_commit_pins/pytorch.txt
            echo "üìå Staged .ci/docker/ci_commit_pins/pytorch.txt"
        else
            echo "‚ÑπÔ∏è  PyTorch commit pin unchanged"
        fi
    else
        if echo "$hook_output" | grep -qi "rate limit exceeded"; then
            echo "‚ö†Ô∏è  PyTorch commit pin not updated due to GitHub API rate limiting."
            echo "   Please manually update .ci/docker/ci_commit_pins/pytorch.txt if needed."
        else
            echo "‚ùå Failed to update PyTorch commit pin"
            echo "Please run: python .github/scripts/update_pytorch_pin.py"
            exit 1
        fi
    fi
fi

exit 0
