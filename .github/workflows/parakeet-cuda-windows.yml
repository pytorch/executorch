# Test Parakeet CUDA build on Windows (MSVC)
# This workflow ensures the Parakeet speech recognition runner builds
# successfully on Windows with the CUDA backend, preventing MSVC regressions.

name: Parakeet CUDA Windows

on:
  pull_request:
    paths:
      - .github/workflows/parakeet-cuda-windows.yml
      - examples/models/parakeet/**
      - extension/llm/**
      - CMakePresets.json
      - CMakeLists.txt
  push:
    branches:
      - main
      - release/*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}-${{ github.event_name == 'schedule' }}
  cancel-in-progress: true

jobs:
  build-parakeet-cuda-windows:
    name: build-parakeet-cuda-windows
    uses: pytorch/test-infra/.github/workflows/windows_job.yml@main
    with:
      runner: windows.g5.4xlarge.nvidia.gpu
      submodules: recursive
      ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      timeout: 90
      script: |
        set -eux
        conda init powershell
        powershell -Command "& {
          Set-PSDebug -Trace 1
          \$ErrorActionPreference = 'Stop'
          \$PSNativeCommandUseErrorActionPreference = \$true

          conda create --yes --quiet -n et python=3.12
          conda activate et
          python install_requirements.py

          echo '==> Building and installing ExecuTorch with CUDA...'
          cmake --workflow --preset llm-release-cuda
          if (\$LASTEXITCODE -ne 0) {
            Write-Host 'ExecuTorch CUDA build failed. Exit code: ' \$LASTEXITCODE
            exit \$LASTEXITCODE
          }

          echo '==> Building Parakeet runner with CUDA...'
          cd examples/models/parakeet
          cmake --workflow --preset parakeet-cuda
          if (\$LASTEXITCODE -ne 0) {
            Write-Host 'Parakeet CUDA build failed. Exit code: ' \$LASTEXITCODE
            exit \$LASTEXITCODE
          }

          echo 'Parakeet CUDA Windows build succeeded.'
        }"
