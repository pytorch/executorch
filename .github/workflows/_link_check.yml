on:
  workflow_call:
    inputs:
      ref:
        type: string
        required: true

jobs:
  lint-urls:
    if: ${{ github.event_name != 'pull_request' || !contains(github.event.pull_request.labels.*.name, 'skip-url-lint') }}
    uses: pytorch/test-infra/.github/workflows/linux_job_v2.yml@release/2.10
    with:
      runner: linux.2xlarge
      docker-image: ci-image:executorch-ubuntu-22.04-linter
      submodules: false
      fetch-depth: 0
      ref: ${{ inputs.ref }}
      timeout: 120
      script: |
        ./scripts/lint_urls.sh $(
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}"
          else
            echo "${{ github.event.before }}" "${{ github.sha }}"
          fi
        ) || {
          echo
          echo "URL lint failed."
          echo "If this is a transient outage, you can bypass it by adding the \`skip-url-lint\` label to your PR."
          echo "Or add \`@lint-ignore\` somewhere on the same line as the URL you want to skip checking."
          exit 1
        }

  lint-xrefs:
    if: ${{ github.event_name != 'pull_request' || !contains(github.event.pull_request.labels.*.name, 'skip-xref-lint') }}
    uses: pytorch/test-infra/.github/workflows/linux_job_v2.yml@release/2.10
    with:
      runner: linux.2xlarge
      docker-image: ci-image:executorch-ubuntu-22.04-linter
      submodules: false
      fetch-depth: 0
      ref: ${{ inputs.ref }}
      timeout: 60
      script: |
        ./scripts/lint_xrefs.sh $(
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}"
          else
            echo "${{ github.event.before }}" "${{ github.sha }}"
          fi
        ) || {
          echo
          echo "Xref lint failed."
          echo "If this is a transient outage, you can bypass it by adding the \`skip-xref-lint\` label to your PR."
          echo "Or add \`@lint-ignore\` somewhere on the same line as the reference you want to skip checking."
          exit 1
        }

  lint-file-size:
    if: ${{ github.event_name == 'pull_request' }}
    uses: pytorch/test-infra/.github/workflows/linux_job_v2.yml@release/2.10
    with:
      runner: linux.2xlarge
      docker-image: ci-image:executorch-ubuntu-22.04-linter
      submodules: false
      fetch-depth: 0
      ref: ${{ inputs.ref }}
      timeout: 30
      script: |
        chmod +x ./scripts/lint_file_size.sh
        ./scripts/lint_file_size.sh $(
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}"
          else
            echo "${{ github.event.before }}" "${{ github.sha }}"
          fi
        ) || {
          echo
          echo "File size lint failed: some files exceed the 1 MB limit."
          echo "If you really need large files, consider using Git LFS or storing them elsewhere."
          echo "If you really need to get unblocked and check in the file, can add it to the EXCEPTIONS list in scripts/lint_file_size.sh."
          exit 1
        }
