name: Update viable/strict

on:
  schedule:
    - cron: 17,47 * * * *
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  do_update_viablestrict:
    if: ${{ github.repository_owner == 'pytorch' }}
    runs-on: ubuntu-22.04
    environment: ${{ (github.event_name == 'schedule') && 'update-viable-strict' || '' }}
    steps:
      - name: Update viable/strict
        id: update
        uses: pytorch/test-infra/.github/actions/update-viablestrict@main
        with:
          repository: pytorch/executorch
          stable-branch: viable/strict
          requires: '[\"pull\", \"lint\", \"trunk\", \"Build documentation\", \"^Apple$\", \"docker-builds\"]'
          secret-bot-token: ${{ secrets.UPDATEBOT_TOKEN }}
          clickhouse-url: ${{ secrets.CLICKHOUSE_URL }}
          clickhouse-username: ${{ secrets.CLICKHOUSE_VIABLESTRICT_USERNAME }}
          clickhouse-password: ${{ secrets.CLICKHOUSE_VIABLESTRICT_PASSWORD }}

      - name: Summarize CI failures
        if: steps.update.outputs.latest_viable_sha == 'None'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## âŒ No green commit found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "viable/strict branch was not updated because no commit passed all required checks." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Failures by commit (recent)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | Title | Failed Job |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|------------|" >> $GITHUB_STEP_SUMMARY

          # Get commits between viable/strict and main using GitHub API
          VIABLE_SHA=$(gh api repos/pytorch/executorch/git/ref/heads/viable/strict --jq '.object.sha' 2>/dev/null || echo "")
          MAIN_SHA=$(gh api repos/pytorch/executorch/git/ref/heads/main --jq '.object.sha' 2>/dev/null || echo "")

          if [ -n "$VIABLE_SHA" ] && [ -n "$MAIN_SHA" ]; then
            # Get commits between viable/strict and main (up to 20)
            COMMITS=$(gh api "repos/pytorch/executorch/compare/${VIABLE_SHA}...${MAIN_SHA}" \
              --jq '.commits | reverse | .[0:20] | .[] | "\(.sha)|\(.commit.message | split("\n")[0] | gsub("\\|"; "-") | .[0:50])"' 2>/dev/null || echo "")

            while IFS='|' read -r sha title; do
              [ -z "$sha" ] && continue
              short_sha="${sha:0:7}"

              # Get workflow runs for this commit
              failed_run=$(gh api "repos/pytorch/executorch/actions/runs?head_sha=${sha}&per_page=100" \
                --jq '.workflow_runs[] | select(.conclusion == "failure" or .conclusion == "cancelled") | "\(.id)|\(.name)"' 2>/dev/null | head -1)

              if [ -n "$failed_run" ]; then
                run_id=$(echo "$failed_run" | cut -d'|' -f1)
                workflow_name=$(echo "$failed_run" | cut -d'|' -f2)

                # Get failed job name
                failed_job=$(gh api "repos/pytorch/executorch/actions/runs/${run_id}/jobs?per_page=100" \
                  --jq '.jobs[] | select(.conclusion == "failure" or .conclusion == "cancelled") | .name' 2>/dev/null | head -1)

                echo "| ${short_sha} | ${title} | ${workflow_name} / ${failed_job:-unknown} |" >> $GITHUB_STEP_SUMMARY
              fi
            done <<< "$COMMITS"
          else
            # Fallback: just show recent failed runs globally
            gh api repos/pytorch/executorch/actions/runs?per_page=20 \
              --jq '.workflow_runs[] | select(.conclusion == "failure") | "\(.id)|\(.head_sha | .[0:7])|\(.display_title | gsub("\\|"; "-") | .[0:50])|\(.name)"' 2>/dev/null | \
            while IFS='|' read -r run_id sha title workflow; do
              failed_job=$(gh api "repos/pytorch/executorch/actions/runs/${run_id}/jobs?per_page=100" \
                --jq '.jobs[] | select(.conclusion == "failure") | .name' 2>/dev/null | head -1)
              if [ -n "$failed_job" ]; then
                echo "| ${sha} | ${title} | ${workflow} / ${failed_job} |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary by job" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          gh api repos/pytorch/executorch/actions/runs?per_page=100 \
            --jq '.workflow_runs[] | select(.conclusion == "failure") | .name' 2>/dev/null \
            | sort | uniq -c | sort -rn | head -10 >> $GITHUB_STEP_SUMMARY || echo "Failed to fetch data" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "::error::No green commit found - viable/strict was not updated"
          exit 1
