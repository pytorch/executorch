name: pull

on:
  pull_request:
  push:
    branches:
      - main
      - release/*
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}-${{ github.event_name == 'schedule' }}
  cancel-in-progress: true

jobs:
  test-samsung-quantmodels-linux:
    name: test-samsung-quantmodels-linux
    # if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
    uses: pytorch/test-infra/.github/workflows/linux_job_v2.yml@main
    permissions:
      id-token: write
      contents: read
    secrets: inherit
    with:
      secrets-env: SAMSUNG_AI_LITECORE_KEY
      runner: linux.2xlarge
      docker-image: ci-image:executorch-ubuntu-22.04-clang12-android
      submodules: "recursive"
      ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      timeout: 180
      script: |
        set -ex

        # The generic Linux job chooses to use base env, not the one setup by the image
        CONDA_ENV=$(conda env list --json | jq -r ".envs | .[-1]")
        conda activate "${CONDA_ENV}"

        # Setup python
        PYTHON_EXECUTABLE=python bash .ci/scripts/setup-linux.sh --build-tool "cmake"

        # Setup Samsung SDK (AI Lite Core) and install enn backend
        export SAMSUNG_AI_LITECORE_KEY=$SECRET_SAMSUNG_AI_LITECORE_KEY
        source .ci/scripts/setup-samsung-linux-deps.sh

        # Check if device was reserved
        if [[ "${DEVICE_RESERVED:-0}" != "1" ]]; then
          echo "::warning::Skipping tests - no Samsung device available"
          exit 0
        fi

        # Test quant models
        model_scripts="deeplab_v3 edsr inception_v3 inception_v4 mobilenet_v2 mobilenet_v3 resnet18 resnet50 vit wav2letter"
        for m_script in $model_scripts; do
          python -m executorch.examples.samsung.scripts.${m_script} -c e9955 -p A8W8
        done

  test-samsung-models-linux:
    name: test-samsung-models-linux
    # if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name != 'pull_request'
    uses: pytorch/test-infra/.github/workflows/linux_job_v2.yml@main
    permissions:
      id-token: write
      contents: read
    secrets: inherit
    with:
      secrets-env: SAMSUNG_AI_LITECORE_KEY
      runner: linux.2xlarge
      docker-image: ci-image:executorch-ubuntu-22.04-clang12-android
      submodules: "recursive"
      ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      timeout: 360
      script: |
        set -ex

        # The generic Linux job chooses to use base env, not the one setup by the image
        CONDA_ENV=$(conda env list --json | jq -r ".envs | .[-1]")
        conda activate "${CONDA_ENV}"

        # Setup python
        PYTHON_EXECUTABLE=python bash .ci/scripts/setup-linux.sh --build-tool "cmake"

        # Setup Samsung SDK (AI Lite Core) and install enn backend
        export SAMSUNG_AI_LITECORE_KEY=$SECRET_SAMSUNG_AI_LITECORE_KEY
        source .ci/scripts/setup-samsung-linux-deps.sh

        # Check if device was reserved
        if [[ "${DEVICE_RESERVED:-0}" != "1" ]]; then
          echo "::warning::Skipping tests - no Samsung device available"
          exit 0
        fi

        # Test models
        python -m unittest discover -s backends/samsung/test/models -p "test_*.py"
